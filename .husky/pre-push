#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üöÄ Running pre-push validation for ML project..."
echo ""

# Type checking
if command -v mypy > /dev/null; then
  echo "üîç Running type checks..."
  mypy src/ || echo "‚ö†Ô∏è  Type check issues found (non-blocking)"
else
  echo "‚ö†Ô∏è  mypy not installed, skipping type checking"
  echo "   Install with: pip install mypy"
fi

echo ""

# Run tests
if command -v pytest > /dev/null; then
  echo "üß™ Running tests..."
  pytest tests/ --cov=src --cov-report=term-missing

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Tests failed! Cannot push."
    exit 1
  fi
else
  echo "‚ö†Ô∏è  pytest not installed, skipping tests"
  echo "   Install with: pip install pytest pytest-cov"
  echo ""
  echo "‚ö†Ô∏è  WARNING: Pushing without running tests!"
  echo "   Press Ctrl+C to cancel, or wait 5 seconds to continue..."
  sleep 5
fi

# Validate notebooks can execute (optional, commented out for speed)
# echo ""
# echo "üìì Validating notebooks..."
# if command -v jupyter > /dev/null; then
#   for notebook in notebooks/**/*.ipynb; do
#     if [ -f "$notebook" ]; then
#       echo "  Checking: $notebook"
#       jupyter nbconvert --to notebook --execute "$notebook" --output-dir=/tmp/ --ExecutePreprocessor.timeout=60
#       if [ $? -ne 0 ]; then
#         echo "‚ùå Notebook execution failed: $notebook"
#         exit 1
#       fi
#     fi
#   done
# else
#   echo "‚ö†Ô∏è  jupyter not installed, skipping notebook validation"
# fi

echo ""
echo "‚úÖ Pre-push validation completed successfully!"
